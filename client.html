<!DOCTYPE html>
<html>
<head>
  <script src="javascript/jquery.min.js"></script>
  <meta charset="utf-8" />
  <title>Surprise!</title>
  <link href="css/bootstrap-combined.min.css" rel="stylesheet">
  <script src="javascript/bootstrap.min.js"></script>
  <script src="javascript/jquery.transit.js"></script>
  <style>
  body {
    width: 100%;
    height: 600px;
  }
.square {
  position: absolute;
  z-index: 2;
  left: 0px;
  top: 0px;
  display: none;
}

.girl {
  position: absolute;
  left: 0px;
  top: 0px;
  width: 100px;
  height: 100px;
  display: none;
}

.gift {
  position: absolute;
  left: 0px;
  top: 0px;
  font-size: 8px;
  color: black;
  display: none;
}

#news_data {
  position: absolute;
  width: 280px;
  right: 0px;
  top: 0px;
}
</style>
</head>
<body>
  <div class="row-fluid">
    <div class="span2">
      <table class="table" style="z-index: 99;">
        <tr>
          <td>
            線上人數:
            <span id="nowClient">0</span>
            人
          </td>
        </tr>
        <tr>
          <td>
            <table id="client_data" class="table table-bordered"></table>
          </td>
        </tr>
        <tr>
          <td>
            <h3>送安麗一個禮物<i class="icon-gift"></i></h3>
            <input type="text" id="text" placeholder="文字或圖片連結">
            <input type="button" id="send" value="送出">
          </td>
        </tr>
      </table>
    </div>
    <table id="news_data" class="table table-bordered"></table>
  </div>
  
  <div id="bubble" class="square">
    <table>
      <tr>
        <td id="speak"></td>
      </tr>
    </table>
  </div>

  <div id="any" class="girl"><img /></div>

  <div id="gift" class="gift"></div>
  
  <div id="fb-root"></div>

</body>
  <script src="/socket.io/socket.io.js"></script>
  <script type="text/javascript">
  window.fbAsyncInit = function() {
    // init the FB JS SDK
    FB.init({
      appId      : '510074642338945', // App ID from the App Dashboard
      channelUrl : '//mr-tvbs.nko3.jitsu.com/channel.php', // Channel File for x-domain communication
      status     : true, // check the login status upon init?
      cookie     : true, // set sessions cookies to allow your server to access the session?
      xfbml      : true  // parse XFBML tags on this page?
    });

    // Additional initialization code such as adding Event Listeners goes here
    FB.login(function(response) {

      if (response.authResponse) {

        FB.api('/me', function(response) {
          var imgurl;
          var accept_from_server = true;
          var socket = io.connect('http://mr-tvbs.nko3.jitsu.com');

          socket.on('connect', function() {
            socket.emit('client_data', {
              username: response.name, //"Guest-"+new Date().getTime(),
            });
            customEvent();
            console.log('Connected');

          });
          socket.on('disconnect', function() {

            var middleLeft = document.body.clientWidth / 2;
            var middleTop = document.body.clientHeight / 2;

            appearAny(middleLeft, middleTop, "http://i.imgur.com/iXzSA.png");
            appearBubble(middleLeft + 90, middleTop, "すみません、すぐに戻る");
          });

          //send text to server
          $("#send").click(function() {
            socket.emit('gift_data', {text: $("#text").prop("value")});
            $("#text").prop("value", "");
            $("#text").focus();
            //public message to everyone
            socket.emit('news_data', {
              username: response.name,
            });
          });

          function appearBubble(left, top, text) {
            $("#bubble").css("left", left+"px");
            $("#bubble").css("top", top+"px");
            $("#speak").html(text);
            $("#bubble").fadeIn();
          }

          function appearAny(left, top, img) {
            $("#gift").fadeOut();
            $("#gift").css("z-index", "1");

            $("#bubble").hide(0);
            $("#any").show(0);
            $("#any").css("left", left+"px");
            $("#any").css("top", top+"px");

            if(img.search("http://") != -1) {
              $("#any").html("<img src='"+img+"'>");
            }
            else {
              $("#any img").prop("src", $("#"+img).prop("src"));
            }
          }

          //客製化事件傳遞
          function customEvent() {

            var global_data = function(data) {
              imgurl = data.imgurl;
            };
            var images_data = function(data) {
              // Add hidden element
              var hidden = $('body').append('<div id="img-cache" style="display:none" />').children('#img-cache');

              $.each(data.special, function (i, val) {
                $('<img/>').prop('id', val).prop('src', imgurl + val + ".png").appendTo(hidden);
              });

              // Add images to hidden element.
              $.each(data.normal, function (i, val) {
                $('<img/>').prop('id', val).prop('src', imgurl + val + ".png").appendTo(hidden);
              });
            };
            var server_data = function(data) {
              $("#nowClient").html(data.nowClient);
            };
            var client_data = function(data) {
              var html = "";
              var arr = new Array();
              arr = data.arr;
              for(var i=0;i<arr.length;i++) {
                html += "<tr><td>"+arr[i]+"</td></tr>";
              }
              $("#client_data").html(html);
            };
            var news_data = function(data) {
              var html = "";
              var arr = new Array();
              arr = data.arr;
              for(var i=arr.length-1;i>=0;i--) {
                html += "<tr><td>"+arr[i]+"</td></tr>";
              }
              $("#news_data").html(html);
            };
            var avatar_data = function(data) {
              if(accept_from_server == true) {
                appearAny(data.left, data.top, data.imgid);
              }
            };
            var bubble_data = function(data) {
              if(accept_from_server == true) {
                appearBubble(data.left, data.top, data.text);
              }
            };
            var gift_to_client = function(data) {

              //reset
              $("#gift").hide(0);
              $("#gift").css("z-index", "999");
              $("#gift").transition({ scale: 1 });

              var str;
              if(data.text != undefined) {
                str = data.text;
              }
              else if(data.img != undefined) {
                str = "<img src='"+data.img+"' width='50'>";
              }

              //stop server runing
              accept_from_server = false;

              var timeoffset = 250;

              var avatarLeft = parseInt($("#any").css("left"), 10);
              var avatarTop = parseInt($("#any").css("top"), 10);
              appearAny(avatarLeft, avatarTop, "nm4");
              appearBubble((avatarLeft+100), avatarTop, "あの、、、これプレゼントをあげる 。///。")

              $("#any").delay(2000);

              $("#any").queue(function () {
                $("#bubble").hide(0);
                $("#any img").prop("src", imgurl+"sp1.png");
                $(this).dequeue();
              }).delay(timeoffset);

              $("#any").queue(function () {
                $("#any img").prop("src", imgurl+"sp2.png");
                $(this).dequeue();
              }).delay(timeoffset);
              $("#any").queue(function () {
                $("#any img").prop("src", imgurl+"sp3.png");
                $(this).dequeue();
              }).delay(timeoffset);
              $("#any").queue(function () {
                $("#any img").prop("src", imgurl+"sp4.png");
                $(this).dequeue();
              }).delay(timeoffset);
              $("#any").queue(function () {
                $("#any img").prop("src", imgurl+"sp1.png");
                $(this).dequeue();
              }).delay(timeoffset);
              $("#any").queue(function () {
                $("#any img").prop("src", imgurl+"sp5.png");
                $(this).dequeue();
              }).delay(timeoffset);
              $("#any").queue(function () {
                $("#any img").prop("src", imgurl+"sp6.png");
                $(this).dequeue();
              }).delay(timeoffset);
              $("#any").queue(function () {
                $("#any img").prop("src", imgurl+"sp7.png");
                $(this).dequeue();
              }).delay(timeoffset);
              $("#any").queue(function () {
                $("#any img").prop("src", imgurl+"sp8.png");
                $(this).dequeue();
              }).delay(timeoffset);
              $("#any").queue(function () {
                $("#any img").prop("src", imgurl+"sp9.png");
                $(this).dequeue();
              }).delay(timeoffset);
              $("#any").queue(function () {
                $("#any img").prop("src", imgurl+"sp10.png");
                $(this).dequeue();
              }).delay(timeoffset);

              $("#any").queue(function () {

                $("#gift").html(str);

                var giftWidth = parseInt($("#gift").css("width"), 10);
                var giftHeight = parseInt($("#gift").css("height"), 10);

                var boxLeft = avatarLeft + 50;
                var boxTop = avatarTop + 50;

                $("#gift").css("left", boxLeft);
                $("#gift").css("top", boxTop);

                var middleLeft = document.body.clientWidth / 2;
                var middleTop = document.body.clientHeight / 2;

                $("#gift").show(0);

                $("#gift").animate({
                  left: middleLeft,
                  top: middleTop
                });

                $("#gift").transition({ scale: 10 });

                $(this).dequeue();

              }).delay(timeoffset + 2000);

              $("#any").queue(function () {
                accept_from_server = true;
                $(this).dequeue();
              });
            };
            socket.on('global_data', global_data);
            socket.on('server_data', server_data);
            socket.on('client_data', client_data);
            socket.on('images_data', images_data);
            socket.on('news_data', news_data);
            socket.on('avatar_data', avatar_data);
            socket.on('bubble_data', bubble_data);
            socket.on('gift_to_client', gift_to_client);
          }
        });
      }
      else {
        alert('請登入Facebook並同意使用本應用程式');
      }
    }, {scope: 'user_about_me, publish_stream'});
  };
  // Load the SDK's source Asynchronously
  (function(d, debug){
     var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement('script'); js.id = id; js.async = true;
     js.src = "//connect.facebook.net/en_US/all" + (debug ? "/debug" : "") + ".js";
     ref.parentNode.insertBefore(js, ref);
  }(document,  false));
</script>
</html>